# Kamal deployment configuration for Patto
# Documentation: https://kamal-deploy.org/docs/configuration/

service: patto

# Docker image name
image: your-dockerhub-username/patto

# Deploy to these servers
servers:
  web:
    hosts:
      - YOUR_SERVER_IP  # Replace with your VPS IP address
    labels:
      traefik.http.routers.patto.rule: Host(`api.patto.example.com`)
      traefik.http.routers.patto.tls: true
      traefik.http.routers.patto.tls.certresolver: letsencrypt
    options:
      network: "private"

# Proxy configuration (Kamal 2.0+)
proxy:
  ssl: true
  host: api.patto.example.com
  app_port: 80  # Thruster exposes on port 80

# Docker registry credentials
registry:
  username: your-dockerhub-username
  password:
    - KAMAL_REGISTRY_PASSWORD

# Build configuration
builder:
  arch: amd64
  context: .
  dockerfile: Dockerfile

# Environment variables
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_LEVEL: info
    RAILS_SERVE_STATIC_FILES: false
    DB_HOST: patto-mysql  # Refers to the accessory container name
    DB_PORT: 3306
    DB_USERNAME: backend
    FRONTEND_URL: https://patto.example.com
    SOLID_QUEUE_IN_PUMA: true
  secret:
    - RAILS_MASTER_KEY
    - BACKEND_DATABASE_PASSWORD

# Accessories (additional services like databases)
accessories:
  mysql:
    image: mysql:8.0
    host: YOUR_SERVER_IP  # Replace with your VPS IP address
    port: "127.0.0.1:3306:3306"  # Only expose locally
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MYSQL_DATABASE: backend_production
        MYSQL_USER: backend
      secret:
        - MYSQL_ROOT_PASSWORD
        - MYSQL_PASSWORD
    directories:
      - mysql_data:/var/lib/mysql
    options:
      network: "private"
      restart: unless-stopped
    cmd: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

# Health check
healthcheck:
  path: /up
  port: 80
  interval: 10s
  max_attempts: 30

# Volumes for persistent data
volumes:
  - "patto_storage:/rails/storage"

# SSH configuration
ssh:
  user: root
  # keys:
  #   - ~/.ssh/id_rsa

# Hooks
hooks:
  pre-deploy:
    # Create additional databases for Solid Cache/Queue/Cable
    - |
      echo "Creating additional databases..."
  post-deploy:
    - |
      echo "Running database migrations..."

# Traefik configuration for SSL
traefik:
  options:
    publish:
      - "443:443"
      - "80:80"
    volume:
      - "/letsencrypt:/letsencrypt"
  args:
    entryPoints.web.address: ":80"
    entryPoints.websecure.address: ":443"
    entryPoints.web.http.redirections.entryPoint.to: websecure
    entryPoints.web.http.redirections.entryPoint.scheme: https
    certificatesResolvers.letsencrypt.acme.email: your-email@example.com
    certificatesResolvers.letsencrypt.acme.storage: /letsencrypt/acme.json
    certificatesResolvers.letsencrypt.acme.httpchallenge.entrypoint: web
