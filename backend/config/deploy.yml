# =============================================================================
# Patto - Kamal デプロイ設定 (Kamal 2.0)
# =============================================================================
# 構成: Cloudflare + ConoHa VPS 1GB
# ドキュメント: https://kamal-deploy.org/docs/configuration/
#
# 使い方:
#   1. このファイルの YOUR_* を実際の値に置き換える
#   2. .kamal/secrets を設定する
#   3. kamal setup を実行
# =============================================================================

service: patto

# -----------------------------------------------------------------------------
# Docker イメージ設定
# -----------------------------------------------------------------------------
image: YOUR_DOCKERHUB_USERNAME/patto

# -----------------------------------------------------------------------------
# デプロイ先サーバー
# -----------------------------------------------------------------------------
servers:
  web:
    hosts:
      - YOUR_SERVER_IP  # ← ConoHa VPS の IP アドレス

# -----------------------------------------------------------------------------
# プロキシ設定 (Kamal 2.0 - kamal-proxy)
# -----------------------------------------------------------------------------
proxy:
  ssl: true
  host: api.YOUR_DOMAIN  # ← api.patto.example.com の形式
  app_port: 80
  healthcheck:
    path: /up
    interval: 3
    timeout: 3

# -----------------------------------------------------------------------------
# Docker レジストリ設定
# -----------------------------------------------------------------------------
registry:
  username: YOUR_DOCKERHUB_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# -----------------------------------------------------------------------------
# ビルド設定
# -----------------------------------------------------------------------------
builder:
  arch: amd64

# -----------------------------------------------------------------------------
# 環境変数
# -----------------------------------------------------------------------------
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_LEVEL: info
    DB_HOST: patto-mysql
    DB_PORT: 3306
    DB_USERNAME: backend
    FRONTEND_URL: https://YOUR_DOMAIN
  secret:
    - RAILS_MASTER_KEY
    - BACKEND_DATABASE_PASSWORD

# -----------------------------------------------------------------------------
# MySQL 設定
# -----------------------------------------------------------------------------
accessories:
  mysql:
    image: mysql:8.0
    host: YOUR_SERVER_IP
    port: "3306:3306"
    env:
      clear:
        MYSQL_ROOT_HOST: '%'
        MYSQL_DATABASE: backend_production
        MYSQL_USER: backend
      secret:
        - MYSQL_ROOT_PASSWORD
        - MYSQL_PASSWORD
    directories:
      - mysql_data:/var/lib/mysql
    cmd: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

# -----------------------------------------------------------------------------
# ボリューム（永続化データ）
# -----------------------------------------------------------------------------
volumes:
  - "patto_storage:/rails/storage"

# -----------------------------------------------------------------------------
# SSH 設定
# -----------------------------------------------------------------------------
ssh:
  user: deploy
